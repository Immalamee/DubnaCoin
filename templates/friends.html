<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î—Ä—É–∑—å—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>
<body>
    <div class="container mt-5" id="user-container" data-user-id="{{ user_id }}">
        <h1 class="text-center mb-4">üë• –í–∞—à–∏ –¥—Ä—É–∑—å—è</h1>
        {% if friends %}
            <ul class="list-group mb-4 shadow-sm rounded-4">
                {% for friend in friends %}
                    <li class="list-group-item">
                        <i class="bi bi-person-fill"></i> {{ friend['Name'] or friend['Username'] }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-center">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π.</p>
        {% endif %}
        <div class="text-center mb-4">
            <button class="btn btn-primary" onclick="getReferralLink()">
                <i class="bi bi-person-plus-fill"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞
            </button>
        </div>
        <div class="text-center">
            <button class="btn btn-secondary" onclick="goBack()">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>

    <button class="btn btn-outline-danger position-fixed end-0 m-3 rounded-circle shadow-lg"
            id="reportErrorButton" style="width: 60px; height: 60px; bottom: 80px;">
        <i class="bi bi-bug-fill" style="font-size: 24px;"></i>
    </button>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-bottom-0">
              <h5 class="modal-title" id="errorModalLabel">–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
              <form id="errorForm">
                <div class="mb-3">
                  <label for="errorMessage" class="form-label">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:</label>
                  <textarea class="form-control rounded-3" id="errorMessage" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-danger w-100 rounded-3">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </form>
            </div>
          </div>
        </div>
    </div>

    <div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
          <div class="modal-header">
            <h5 class="modal-title" id="referralModalLabel">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
          <div class="modal-body text-center" id="referralModalBody">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º userToken –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        window.userToken = "{{ token }}";
    </script>
    <script>
        function getReferralLink() {
            const container = document.getElementById('user-container');
            const userId = container.getAttribute('data-user-id');
            const referralLink = `https://t.me/DubnaCoinBot?start=${userId}`;

            const modalBody = document.getElementById('referralModalBody');
            modalBody.innerHTML = `
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="referralLinkInput" value="${referralLink}" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="copyButton">
                        <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
                <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å—ã!</p>
            `;

            const referralModal = new bootstrap.Modal(document.getElementById('referralModal'));
            referralModal.show();

            document.getElementById('copyButton').addEventListener('click', function() {
                const referralInput = document.getElementById('referralLinkInput');
                referralInput.select();
                referralInput.setSelectionRange(0, 99999);

                navigator.clipboard.writeText(referralInput.value).then(function() {
                    showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }, function(err) {
                    showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏: ' + err);
                });
            });
        }

        function goBack() {
            window.location.href = `/?token=${encodeURIComponent(window.userToken)}`;
        }

        function showToast(message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-bg-${type} border-0 rounded-3 shadow-lg m-3`;
            toastEl.role = 'alert';
            toastEl.ariaLive = 'assertive';
            toastEl.ariaAtomic = 'true';
            toastEl.style.maxWidth = '350px';
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
            `;
            document.body.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        function showModal(title, message) {
            const modalTitle = document.getElementById('infoModalLabel');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = title;
            modalBody.textContent = message;

            const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
            infoModal.show();
        }
    </script>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Toast -->
    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

</body>
</html>
