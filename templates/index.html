<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DubnaCoin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container text-center mt-5">
      <h1 id="welcome-message" class="mb-4">Добро пожаловать в <span class="text-primary">DubnaCoin!</span></h1>
      <p class="lead">Ваш уровень: <span id="level"></span></p>
      <p class="lead">Ваши монеты: <span id="coins"></span></p>
      <button id="coin-button" class="btn btn-outline-primary my-4 rounded-circle shadow">
          <img id="coin-image" src="" alt="Coin" class="img-fluid coin-img">
      </button>
      <div class="d-flex justify-content-center">
          <button id="shop-button" class="btn btn-primary me-2">
              <i class="bi bi-shop"></i> Магазин
          </button>
          <button id="friends-button" class="btn btn-secondary">
              <i class="bi bi-people"></i> Друзья
          </button>
      </div>
    </div>

    <button class="btn btn-outline-danger position-fixed bottom-0 start-0 m-3 rounded-circle shadow-lg" id="reportErrorButton" style="width: 60px; height: 60px;">
      <i class="bi bi-bug-fill" style="font-size: 24px;"></i>
    </button>

    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>
    
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
          <div class="modal-header border-bottom-0">
            <h5 class="modal-title" id="errorModalLabel">Сообщить об ошибке</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <form id="errorForm">
              <div class="mb-3">
                <label for="errorMessage" class="form-label">Опишите проблему:</label>
                <textarea class="form-control rounded-3" id="errorMessage" rows="4" required></textarea>
              </div>
              <button type="submit" class="btn btn-danger w-100 rounded-3">Отправить</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">Сообщение</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body" id="modalBody">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const initData = window.Telegram.WebApp.initData || '';
        console.log('initData:', initData);
        const urlParams = new URLSearchParams(window.location.search);
        const referrer_id = urlParams.get('ref');

        fetch('/process_init_data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ initData: initData, referrer_id: referrer_id })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Обновляем приветственное сообщение
            document.getElementById('welcome-message').innerHTML = `Добро пожаловать, <span class="text-primary">${data.username}</span>!`;

            // Устанавливаем уровень и количество монет
            document.getElementById('level').innerText = data.level;
            document.getElementById('coins').innerText = data.coins;

            // Устанавливаем изображение монеты
            const coinImage = document.getElementById('coin-image');
            coinImage.src = `/static/images/${data.current_skin}`;

            // Добавляем обработчик клика по кнопке
            document.getElementById('coin-button').addEventListener('click', function() {
              clickCoin();
            });
          } else {
            document.getElementById('welcome-message').innerText = `Ошибка: ${data.error}`;
          }
        })
        .catch(error => {
          console.error('Ошибка сети:', error);
          document.getElementById('welcome-message').innerText = 'Ошибка сети. Пожалуйста, попробуйте позже.';
        });
      });

      function clickCoin() {
        fetch('/click', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.coins !== undefined) {
            document.getElementById('coins').innerText = data.coins;
          }
        })
        .catch(error => {
          console.error('Ошибка при клике:', error);
        });
      }

      function openShop() {
        window.location.href = '/shop';
      }

      function openFriends() {
        window.location.href = '/friends';
      }
    </script>
</body>
</html>
